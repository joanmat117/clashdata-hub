<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clash Royale Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <!-- Remix Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <!-- Configuración básica de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cr: {
                            base: '#1a1c23',
                            card: '#252830',
                            accent: '#3b82f6',
                            gold: '#fbbf24'
                        }
                    }
                }
            }
        }
    </script>
    <style>
    body {
      color:#000;
      background:#ccf;
    }
    * {
      color: #000;
    }
        /* Scrollbar personalizada para un look más limpio */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1c23; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        .tab-btn.active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
    </style>
</head>
<body class="bg-cr-base text-gray-200 font-sans min-h-screen">

    <!-- Navbar -->
    <nav class="bg-cr-card border-b border-gray-700 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="ri-sword-fill text-2xl text-cr-accent"></i>
                <span class="font-bold text-xl tracking-tight">RoyaleAPI</span>
            </div>
            <div class="flex space-x-4 text-sm font-medium">
                <button onclick="switchTab('player')" id="tab-player" class="tab-btn active px-3 py-2 transition-colors">Jugador</button>
                <button onclick="switchTab('clan')" id="tab-clan" class="tab-btn px-3 py-2 transition-colors">Clan</button>
                <button onclick="switchTab('cards')" id="tab-cards" class="tab-btn px-3 py-2 transition-colors">Cartas</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6" id="app">
        
        <!-- Error/Success Notification -->
        <div id="toast" class="hidden fixed bottom-4 right-4 bg-red-600 text-white px-4 py-2 rounded shadow-lg z-50"></div>

        <!-- ================= PLAYER SECTION ================= -->
        <section id="view-player" class="space-y-6">
            <div class="flex gap-2 max-w-md mx-auto">
                <div class="relative flex-1">
                    <i class="ri-hashtag absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="player-tag" placeholder="Tag del Jugador (ej. 2P0LYQ)" 
                           class="w-full bg-cr-card border border-gray-600 rounded-lg py-2 pl-8 pr-4 focus:outline-none focus:border-cr-accent text-white uppercase">
                </div>
                <button onclick="fetchPlayer()" class="bg-cr-accent hover:bg-blue-600 text-white px-6 rounded-lg font-medium transition-colors">
                    <i class="ri-search-line"></i>
                </button>
            </div>

            <div id="player-loading" class="hidden text-center py-10"><i class="ri-loader-4-line animate-spin text-3xl"></i></div>
            
            <div id="player-content" class="hidden space-y-6">
                <!-- Profile Header -->
                <div class="bg-cr-card rounded-xl p-6 shadow-lg border border-gray-700 flex flex-col md:flex-row gap-6 items-center md:items-start">
                    <div class="text-center md:text-left flex-1">
                        <h2 class="text-3xl font-bold text-white flex items-center justify-center md:justify-start gap-2">
                            <span id="p-name">Nombre</span>
                            <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300" id="p-tag">#TAG</span>
                        </h2>
                        <p class="text-gray-400 mt-1" id="p-clan">Sin Clan</p>
                        <div class="grid grid-cols-3 gap-4 mt-4 text-center md:text-left">
                            <div><p class="text-xs text-gray-500">Nivel</p><p class="font-bold text-xl" id="p-level">-</p></div>
                            <div><p class="text-xs text-gray-500">Trofeos</p><p class="font-bold text-xl text-cr-gold" id="p-trophies">-</p></div>
                            <div><p class="text-xs text-gray-500">Max Trofeos</p><p class="font-bold text-xl" id="p-best">-</p></div>
                        </div>
                    </div>
                </div>

                <!-- Current Deck -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i class="ri-stack-line text-cr-accent"></i> Mazo Actual</h3>
                    <div class="grid grid-cols-4 md:grid-cols-8 gap-2" id="p-deck"></div>
                </div>

                <!-- Battles Log -->
                <div>
                    <h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i class="ri-sword-line text-red-400"></i> Últimas Batallas</h3>
                    <div class="space-y-2" id="p-battles"></div>
                </div>
            </div>
        </section>

        <!-- ================= CLAN SECTION ================= -->
        <section id="view-clan" class="hidden space-y-6">
            <div class="flex gap-2 max-w-md mx-auto">
                <div class="relative flex-1">
                    <i class="ri-group-line absolute left-3 top-3 text-gray-400"></i>
                    <input type="text" id="clan-search-term" placeholder="Buscar clan por nombre..." 
                           class="w-full bg-cr-card border border-gray-600 rounded-lg py-2 pl-8 pr-4 focus:outline-none focus:border-cr-accent text-white">
                </div>
                <button onclick="searchClans()" class="bg-cr-accent hover:bg-blue-600 text-white px-6 rounded-lg font-medium">
                    <i class="ri-search-line"></i>
                </button>
            </div>

            <!-- Search Results -->
            <div id="clan-search-results" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

            <!-- Clan Details (Modal-like view or below) -->
            <div id="clan-details" class="hidden bg-cr-card rounded-xl border border-gray-700 p-6">
                <div class="flex justify-between items-start mb-6 border-b border-gray-700 pb-4">
                    <div>
                        <h2 class="text-3xl font-bold" id="c-name">Clan Name</h2>
                        <p class="text-gray-400 text-sm" id="c-desc">Description</p>
                    </div>
                    <button onclick="closeClanDetails()" class="text-gray-500 hover:text-white"><i class="ri-close-line text-2xl"></i></button>
                </div>
                
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-bold text-lg mb-3">Miembros</h3>
                        <div class="h-64 overflow-y-auto space-y-1 pr-2" id="c-members"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg mb-3">Historial de Guerra</h3>
                        <div class="h-64 overflow-y-auto space-y-2 pr-2" id="c-wars"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ================= CARDS SECTION ================= -->
        <section id="view-cards" class="hidden">
            <div id="cards-loader" class="text-center py-10"><i class="ri-loader-4-line animate-spin text-3xl"></i></div>
            <div id="cards-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3"></div>
        </section>

    </main>

    <script>
        // --- Utils & State ---
        const API_BASE = 'https://clashdata-hub.onrender.com'; // Mismo dominio
        
        function showToast(msg, isError = true) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg z-50 text-white ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function formatTag(tag) {
            let t = tag.toUpperCase().replace('#', '');
            return t; // La API suele requerir sin # en la URL, o con %23. Tu endpoint dirá. Asumiré URL limpia.
        }

        function switchTab(tab) {
            ['player', 'clan', 'cards'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('active');
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            if(tab === 'cards' && document.getElementById('cards-grid').children.length === 0) {
                fetchCards();
            }
        }

        // --- Generic Fetch Wrapper ---
        async function apiCall(endpoint) {
            try {
                const res = await fetch(API_BASE + endpoint);
                const json = await res.json();
                if(!json.success) throw new Error(json.error || 'Error desconocido');
                return json.data;
            } catch (e) {
                console.error(e);
                showToast(e.message);
                return null;
            }
        }

        // --- Player Logic ---
        async function fetchPlayer() {
            const tagInput = document.getElementById('player-tag').value.trim();
            if(!tagInput) return showToast('Ingresa un tag de jugador');
            
            const tag = formatTag(tagInput);
            document.getElementById('player-loading').classList.remove('hidden');
            document.getElementById('player-content').classList.add('hidden');

            try {
                // Parallel fetch: Player Info & Battles
                const [player, battles] = await Promise.all([
                    apiCall(`/player/${tag}`),
                    apiCall(`/player/${tag}/battles`)
                ]);

                if (player) renderPlayerProfile(player);
                if (battles) renderBattles(battles);
                
                if(player) document.getElementById('player-content').classList.remove('hidden');

            } catch(e) { showToast('Error cargando jugador'); } 
            finally { document.getElementById('player-loading').classList.add('hidden'); }
        }

        function renderPlayerProfile(p) {
            document.getElementById('p-name').textContent = p.name;
            document.getElementById('p-tag').textContent = p.tag;
            document.getElementById('p-clan').textContent = p.clan ? p.clan.name : 'Sin Clan';
            document.getElementById('p-level').textContent = p.expLevel;
            document.getElementById('p-trophies').textContent = p.trophies;
            document.getElementById('p-best').textContent = p.bestTrophies;

            const deckContainer = document.getElementById('p-deck');
            deckContainer.innerHTML = '';
            p.currentDeck.forEach(card => {
                deckContainer.innerHTML += `
                    <div class="relative aspect-[3/4] bg-gray-800 rounded overflow-hidden shadow border border-gray-600">
                        <img src="${card.iconUrls.medium}" class="w-full h-full object-cover">
                        <span class="absolute bottom-0 right-0 bg-black bg-opacity-70 text-xs px-1 text-white font-bold">Lvl ${14 - (card.maxLevel - card.level + 1)}</span>
                    </div>`;
            });
        }

        function renderBattles(battles) {
            const container = document.getElementById('p-battles');
            container.innerHTML = '';
            battles.slice(0, 10).forEach(b => {
                const win = b.team[0].crowns > b.opponent[0].crowns;
                const resultColor = win ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500';
                const time = new Date(b.battleTime).toLocaleDateString();
                
                container.innerHTML += `
                    <div class="bg-gray-800 p-3 rounded flex justify-between items-center ${resultColor}">
                        <div>
                            <span class="font-bold text-sm ${win ? 'text-green-400' : 'text-red-400'}">${win ? 'VICTORIA' : 'DERROTA'}</span>
                            <div class="text-xs text-gray-400">${b.type} • ${time}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold">vs ${b.opponent[0].name}</div>
                            <div class="text-xs text-gray-400"><i class="ri-vip-crown-fill text-yellow-500"></i> ${b.team[0].crowns} - ${b.opponent[0].crowns}</div>
                        </div>
                    </div>`;
            });
        }

        // --- Clan Logic ---
        async function searchClans() {
            const term = document.getElementById('clan-search-term').value;
            if(term.length < 3) return showToast('Escribe al menos 3 caracteres');

            const results = await apiCall(`/search?name=${encodeURIComponent(term)}`);
            const container = document.getElementById('clan-search-results');
            container.innerHTML = '';
            document.getElementById('clan-details').classList.add('hidden');

            if(results && results.items) {
                results.items.forEach(c => {
                    container.innerHTML += `
                        <div onclick="fetchClanDetails('${c.tag}')" class="bg-cr-card p-4 rounded-lg border border-gray-700 cursor-pointer hover:border-cr-accent transition-colors flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-lg">${c.name}</h4>
                                <span class="text-xs text-gray-400">${c.tag}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm"><i class="ri-user-line"></i> ${c.members}/50</div>
                                <div class="text-sm text-cr-gold"><i class="ri-trophy-fill"></i> ${c.clanScore}</div>
                            </div>
                        </div>`;
                });
            } else {
                container.innerHTML = '<p class="text-gray-500 col-span-2 text-center">No se encontraron clanes.</p>';
            }
        }

        async function fetchClanDetails(tag) {
            const cleanTag = formatTag(tag);
            // La ruta especificada para clan details es /:tag, y miembros /:tag/members.
            // Asumiendo que el server maneja la raiz como clan router si no es /player o /search.
            
            showToast('Cargando clan...', false);
            
            try {
                const [details, members, wars] = await Promise.all([
                    apiCall(`/${cleanTag}`),
                    apiCall(`/${cleanTag}/members`),
                    apiCall(`/${cleanTag}/wars`)
                ]);

                if(details) {
                    document.getElementById('clan-search-results').innerHTML = ''; // Limpiar búsqueda
                    const detailEl = document.getElementById('clan-details');
                    detailEl.classList.remove('hidden');

                    document.getElementById('c-name').textContent = details.name;
                    document.getElementById('c-desc').textContent = details.description || 'Sin descripción';

                    // Members List
                    const memEl = document.getElementById('c-members');
                    memEl.innerHTML = '';
                    if(members) {
                        members.forEach(m => {
                            memEl.innerHTML += `
                                <div class="flex justify-between items-center py-2 border-b border-gray-700 last:border-0">
                                    <div class="flex flex-col">
                                        <span class="font-medium text-sm text-white">${m.name}</span>
                                        <span class="text-xs text-gray-500">${m.role}</span>
                                    </div>
                                    <div class="text-sm font-bold text-cr-gold">${m.trophies} <i class="ri-trophy-fill text-xs"></i></div>
                                </div>`;
                        });
                    }

                    // Wars Log
                    const warEl = document.getElementById('c-wars');
                    warEl.innerHTML = '';
                    if(wars) {
                        wars.forEach(w => {
                            const date = new Date(w.createdDate).toLocaleDateString();
                            warEl.innerHTML += `
                                <div class="bg-gray-800 p-2 rounded text-sm mb-2">
                                    <div class="flex justify-between text-xs text-gray-400 mb-1">
                                        <span>Temp ${w.seasonId}</span>
                                        <span>${date}</span>
                                    </div>
                                    <div class="font-medium">Posición: #${w.standing || '?'}</div>
                                </div>`;
                        });
                    }
                }
            } catch(e) { showToast('Error cargando detalles del clan'); }
        }

        function closeClanDetails() {
            document.getElementById('clan-details').classList.add('hidden');
            document.getElementById('clan-search-results').innerHTML = ''; // Opcional: limpiar o restaurar búsqueda
        }

        // --- Cards Logic ---
        async function fetchCards() {
            document.getElementById('cards-loader').classList.remove('hidden');
            const data = await apiCall('/cards');
            document.getElementById('cards-loader').classList.add('hidden');
            
            const grid = document.getElementById('cards-grid');
            if(data && data.items) {
                // Ordenar por rareza o elixir opcionalmente
                data.items.forEach(c => {
                    grid.innerHTML += `
                        <div class="bg-cr-card rounded-lg p-2 flex flex-col items-center hover:scale-105 transition-transform">
                            <img src="${c.iconUrls.medium}" alt="${c.name}" class="w-full object-contain mb-2" loading="lazy">
                            <span class="text-xs font-bold text-center leading-tight">${c.name}</span>
                        </div>`;
                });
            }
        }
    </script>
</body>
</html>